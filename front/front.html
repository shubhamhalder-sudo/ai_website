<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INT. Global AI</title>
    <style>
        :root {
            --primary-blue: #0056b3;
            --primary-hover: #004494;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #e9ecef;
            --shadow-sm: 0 4px 6px rgba(0,0,0,0.04);
            --shadow-md: 0 10px 20px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; }

        /* HEADER */
        nav {
            background-color: var(--card-bg); padding: 20px 40px; position: sticky; top: 0; z-index: 100;
            box-shadow: var(--shadow-sm); display: flex; flex-direction: column; align-items: center; gap: 20px;
        }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--primary-blue); text-decoration: none; align-self: flex-start; }
        
        /* SEARCH */
        .search-container { width: 100%; max-width: 800px; }
        .search-bar-wrapper {
            display: flex; align-items: center; background: var(--bg-color); border: 1px solid #ddd;
            border-radius: 50px; padding: 10px 10px 10px 24px; transition: all 0.3s ease;
        }
        .search-bar-wrapper:focus-within { border-color: var(--primary-blue); background: white; box-shadow: 0 4px 12px rgba(0, 86, 179, 0.1); }
        input[type="text"] { flex: 1; border: none; background: transparent; font-size: 1.1rem; outline: none; color: var(--text-main); }
        .search-btn {
            background-color: var(--primary-blue); color: white; border: none; border-radius: 50%; width: 44px; height: 44px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;
        }
        .search-btn:hover { background-color: var(--primary-hover); transform: scale(1.05); }
        .search-btn:disabled { background-color: #e9ecef; color: #adb5bd; cursor: default; transform: none; }

        /* CONTENT */
        main { flex: 1; max-width: 1200px; width: 100%; margin: 0 auto; padding: 40px 20px; display: flex; flex-direction: column; gap: 30px; }
        
        .empty-state { text-align: center; margin-top: 100px; color: var(--text-muted); }
        .empty-state h2 { font-size: 2rem; margin-bottom: 15px; color: var(--primary-blue); }

        /* AI ANSWER SECTION */
        .ai-answer-section { animation: fadeIn 0.5s ease; padding: 0 10px; }
        
        /* HEADING & ICON ANIMATION */
        .ai-heading { 
            font-size: 0.9rem; font-weight: 700; margin-bottom: 15px; color: var(--text-muted); 
            text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px;
            transition: color 0.5s ease;
        }
        
        .ai-icon { transition: all 0.5s ease; color: var(--text-muted); }
        
        /* State: Active (Thinking) */
        .ai-heading.active .ai-icon { 
            color: var(--primary-blue); 
            animation: breathe 2s infinite ease-in-out; 
        }
        /* State: Finished (Done) */
        .ai-heading.finished .ai-icon { 
            color: var(--primary-blue); 
            transform: scale(1.1);
        }
        .ai-heading.finished { color: var(--primary-blue); }

        @keyframes breathe { 0% { opacity: 0.5; transform: scale(0.95); } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.5; transform: scale(0.95); } }

        /* TEXT STYLING */
        .ai-text {
            font-size: 1.15rem; line-height: 1.7; color: #333; white-space: pre-wrap;
            font-weight: 400; max-width: 900px;
        }

        /* CURSOR LOGIC */
        .cursor-blink {
            display: inline-block; width: 6px; height: 18px; background-color: var(--primary-blue);
            animation: blink 1s step-end infinite; vertical-align: text-bottom; margin-left: 2px;
        }
        .cursor-blink.fade-out { animation: fadeOutCursor 0.5s forwards; }
        
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes fadeOutCursor { from { opacity: 1; } to { opacity: 0; } }

        /* CARDS GRID */
        .results-section { margin-top: 30px; display: none; border-top: 1px solid var(--border-color); padding-top: 30px; }
        .results-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px;
            width: 100%; margin-top: 15px;
        }

        .info-card {
            background: var(--card-bg); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; flex-direction: column; height: 100%;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .info-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); border-color: var(--primary-blue); }

        .card-image-container { height: 140px; width: 100%; background-color: #f1f1f1; position: relative; }
        .card-image { width: 100%; height: 100%; object-fit: cover; }
        
        .card-content { padding: 15px; display: flex; flex-direction: column; flex-grow: 1; }
        .card-title { font-size: 1rem; font-weight: 700; margin-bottom: 8px; color: var(--primary-blue); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-clamp: 2 ; }
        .card-snippet { font-size: 0.85rem; color: #555; line-height: 1.5; margin-bottom: 15px; flex-grow: 1; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; line-clamp: 3; }
        
        .card-footer { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 10px; text-align: right; }
        .deep-link-btn { color: var(--primary-blue); font-weight: 600; font-size: 0.8rem; text-decoration: none; }
        .deep-link-btn:hover { text-decoration: underline; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* LOADER */
        .loader-container { display: none; justify-content: center; margin-top: 50px; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav>
        <div style="width: 100%; max-width: 1000px; display:flex; flex-direction: column; gap: 15px;">
            <a href="/" class="brand">INT. <span style="font-weight:400; color:#666;">Intelligence</span></a>
            <form class="search-container" id="search-form">
                <div class="search-bar-wrapper">
                    <input type="text" id="query-input" placeholder="Ask anything..." autocomplete="off">
                    <button type="submit" class="search-btn" id="search-btn">
                        <!-- Search Icon -->
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                </div>
            </form>
        </div>
    </nav>

    <main>
        <!-- Empty State -->
        <div id="empty-state" class="empty-state">
            <h2>How can I help you today?</h2>
            <p>Ask about employees, case studies, or company insights.</p>
        </div>

        <!-- Loader -->
        <div id="loader" class="loader-container">
            <div class="spinner"></div>
        </div>

        <!-- Results -->
        <div id="results-area" style="display: none;">
            
            <div class="ai-answer-section">
                <!-- Added ID to Heading for Animation Control -->
                <div id="ai-status-heading" class="ai-heading">
                    <svg class="ai-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                    INT. AI Answer
                </div>
                <!-- TEXT STREAM TARGET -->
                <p id="streaming-text" class="ai-text"></p>
            </div>

            <!-- CARDS CONTAINER -->
            <div id="cards-section" class="results-section">
                <div class="ai-heading">Sources & Refs</div>
                <div id="cards-grid" class="results-grid"></div>
            </div>
        </div>
    </main>

    <script>
        const searchForm = document.getElementById('search-form');
        const queryInput = document.getElementById('query-input');
        const emptyState = document.getElementById('empty-state');
        const loader = document.getElementById('loader');
        const resultsArea = document.getElementById('results-area');
        const streamingTextEl = document.getElementById('streaming-text');
        const aiStatusHeading = document.getElementById('ai-status-heading');
        const cardsSection = document.getElementById('cards-section');
        const cardsGrid = document.getElementById('cards-grid');
        const searchBtn = document.getElementById('search-btn');

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = queryInput.value.trim();
            if (!query) return;

            // 1. Reset UI & Start Loading
            resetUIForNewQuery();

            try {
                const response = await fetch(`http://127.0.0.1:8000/query/stream?user_input=${encodeURIComponent(query)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                // 2. Hide Loader, Show Content Area
                loader.style.display = 'none';
                resultsArea.style.display = 'block';

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let buffer = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    let lines = buffer.split("\n");
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        if (!line.trim()) continue;
                        try {
                            const msg = JSON.parse(line);
                            handleStreamEvent(msg);
                        } catch (err) { console.error("Parse error", err); }
                    }
                }

            } catch (error) {
                console.error(error);
                streamingTextEl.textContent = "Error connecting to server.";
            } finally {
                // 3. Graceful Completion Effect
                finishStreamingEffect();
            }
        });

        function resetUIForNewQuery() {
            emptyState.style.display = 'none';
            resultsArea.style.display = 'none';
            cardsSection.style.display = 'none'; 
            loader.style.display = 'flex';
            
            cardsGrid.innerHTML = ''; 
            streamingTextEl.innerHTML = ''; 
            
            // Set Header to "Thinking" state
            aiStatusHeading.className = 'ai-heading active';

            // Add Cursor
            const cursor = document.createElement('span');
            cursor.className = 'cursor-blink';
            streamingTextEl.appendChild(cursor);

            queryInput.blur();
            searchBtn.disabled = true;
        }

        function handleStreamEvent(msg) {
            const cursor = document.querySelector('.cursor-blink');

            if (msg.type === 'delta') {
                const textNode = document.createTextNode(msg.content);
                if (cursor) {
                    streamingTextEl.insertBefore(textNode, cursor);
                } else {
                    streamingTextEl.appendChild(textNode);
                }
            } 
            else if (msg.type === 'card_item') {
                cardsSection.style.display = 'block';
                appendSingleCard(msg.content);
            }
        }

        function finishStreamingEffect() {
            // 1. Re-enable Search Button
            searchBtn.disabled = false;

            // 2. Change Header State to "Finished" (Solid Blue Icon)
            aiStatusHeading.className = 'ai-heading finished';

            // 3. Gracefully fade out the cursor
            const cursor = document.querySelector('.cursor-blink');
            if (cursor) {
                cursor.classList.add('fade-out');
                setTimeout(() => cursor.remove(), 500); // Remove after animation
            }
        }

        function appendSingleCard(card) {
            const article = document.createElement('article');
            article.className = 'info-card';
            
            const img = card.image || 'https://via.placeholder.com/400x200?text=INT.+Global';
            
            article.innerHTML = `
                <div class="card-image-container">
                    <img src="${img}" class="card-image" onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
                </div>
                <div class="card-content">
                    <h3 class="card-title" title="${card.title}">${card.title}</h3>
                    <p class="card-snippet">${card.snippet}</p>
                    <div class="card-footer">
                        <a href="${card.deep_link || '#'}" target="_blank" class="deep-link-btn">Read Source â†’</a>
                    </div>
                </div>
            `;
            cardsGrid.appendChild(article);
        }
    </script>
</body>
</html>